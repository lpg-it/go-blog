## 获取地区信息

### 流程

**请求地域信息**：/api/v1.0/areas

- 从缓存中获取数据
  - 有缓存数据：
    - 直接返回地域信息 json
  - 没有缓存数据：
    - 从 MySQL 中查找全部 areas 数据
    - 将数据打包成 json 字符串存入缓存
    - 返回地域信息 json 给前端

### 接口

```json
# Request: 
method: GET
url: api/v1.0/areas
# data:
no input data

# Response:
# 返回成功
{
    "errno": 0,
    "errmsg": "ok",
    "data": [
        {"aid": 1, "aname": "东城区"},
        {"aid": 2, "aname": "西城区"},
        ...
    ]
}
        
# 返回失败
{
	"errno": "400x", // 状态码
    "errmsg": "状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetArea
```

修改名称 `example.proto` 为 `getarea.proto`，上一级文件夹名称也由 `example` 改为 `getarea`

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetArea/proto$ tree
.
└── getarea
    └── getarea.proto

1 directory, 1 files
```

### Redis 的安装

具体 Redis 的安装与使用， 请查看此文章： 

#### 安装 Redis

下载

```shell
$ wget http://download.redis.io/releases/redis-6.0.5.tar.gz
```

或者进入网址下载指定版本: [http://download.redis.io/releases/](http://download.redis.io/releases/)

解压

```shell
$ tar xzf redis-6.0.5.tar.gz
```

进入

```shell
$ cd redis-6.0.5
```

编译

```shell
$ make
```

安装

```shell
$ sudo make install
```

验证

```shell
$ redis-cli
Could not connect to Redis at 127.0.0.1:6379: Connection refused
not connected> 
```

![image.png](https://i.loli.net/2020/06/18/Xuyckr853vzpJg4.png)

#### 启动 Redis

将 redis 安装包中的 `redis.conf` 文件复制到项目中 ihome 服务的 conf 文件夹当中

然后， 修改 `redis.conf` 文件

```shell
# 69 行左右
bind 127.0.0.1 当前主机ip
# 136 行左右修改为 yes，表示守护进程启动
daemonize yes
```

在 ihome 服务中创建一个启动文件

```shell
$ sudo vim server.sh
```

文件内容

```shell
redis-server ./conf/redis.conf
```

给文件赋予启动权限

```shell
$ chmod 777 server.sh
```

### 安装 Go语言的 Redis api 驱动

```shell
$ go get -v -u github.com/gomodule/redigo/redis
$ go get -v -u github.com/garyburd/redigo
```

### 安装 beego 的 cache 缓存模块

```shell
$ go get -v -u github.com/astaxie/beego/cache
```

### 编写 ptoro 文件 

```protobuf
syntax = "proto3";

package go.micro.srv.GetArea;

service Example {
  rpc GetArea(Request) returns (Response) {}
}

message Request {

}

message Response {
  // 返回错误码
  string ErrNo = 1;
  // 返回错误信息
  string ErrMsg = 2;
  // 返回数据类型
  message Area {
    int32 Aid = 1;
    string Aname = 2;
  }
  // 用自定义类型返回的数组
  repeated Area Data = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetArea

$ protoc --proto_path=. --go_out=. --micro_out=. proto/getarea/getarea.proto
```

### Web 端

修改 main.go 文件：添加路由

```go
// 获取地区信息
rou.GET("/api/v1.0/areas", handler.GetArea)
```

`handler.go` 增加 `GetArea` 函数

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/julienschmidt/httprouter"
	"github.com/micro/go-grpc"
	getarea "ihome/GetArea/proto/getarea"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"net/http"
)

// 获取地区信息
func GetArea(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	// 创建新的 gRPC 返回句柄
	server := grpc.NewService()
	// 服务初始化
	server.Init()

	// 创建获取地区的服务并且返回句柄
	exampleClient := getarea.NewExampleService("go.micro.srv.GetArea", server.Client())
	// 调用函数并且返回数据
	rsp, err := exampleClient.GetArea(context.TODO(), &getarea.Request{})
	if err != nil {
		return
	}
	// 创建返回类型的切片
	var areas []models.Area
	// 循环读取服务返回的数据
	for _, value := range rsp.Data {
		areas = append(areas, models.Area{Id: int(value.Aid), Name: value.Aname})
	}
	// 创建返回数据 map
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   areas,
	}
	// 注意
	w.Header().Set("Content-Type", "application/json")

	// 将返回的数据 map 发送给前端
	if err := json.NewEncoder(w).Encode(response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
}
```

### Server 端

修改 `main.go` 内容，**之后每次都和下面一样进行修改**

```go
package main

import (
	"github.com/micro/go-grpc"
	"github.com/micro/go-log"
	"github.com/micro/go-micro"
	"ihome/GetArea/handler"
    // 此处修改
	getarea "ihome/GetArea/proto/getarea"
)

func main() {
	// New Service
    // 此处修改：micro 改为 grpc
	service := grpc.NewService(
		micro.Name("go.micro.srv.GetArea"),
		micro.Version("latest"),
	)

	// Initialise service
	service.Init()

	// Register Handler
    // 此处修改 example 改为 getarea
    // handler.Example 改为 handler.Server
	getarea.RegisterExampleHandler(service.Server(), new(handler.Server))

	// Run service
	if err := service.Run(); err != nil {
		log.Fatal(err)
	}
}
```

`handler` 下 `example.go` 文件

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	"github.com/astaxie/beego/orm"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"time"

	_ "github.com/astaxie/beego/cache/redis"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	getarea "ihome/GetArea/proto/getarea"
)

type Server struct{}

func (e *Server) GetArea(ctx context.Context, req *getarea.Request, rsp *getarea.Response) error {
	// 初始化 错误码
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	// 1. 从缓存中获取数据
	// 准备连接 redis 信息
	redisConf := map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	}

	// 将 map 转化为 json
	redisConfJson, _ := json.Marshal(redisConf)
	// 创建 redis 句柄
	bm, err := cache.NewCache("redis", string(redisConfJson))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	// 获取数据
	areaInfo := bm.Get("areaInfo")
	if areaInfo != nil {
		// 缓存中有数据
		var areas []map[string]interface{}
		// 将获取到的数据解码
		json.Unmarshal(areaInfo.([]byte), &areas)

		for _, value := range areas {
			rsp.Data = append(rsp.Data, &getarea.Response_Area{Aid: int32(value["aid"].(float64)), Aname: value["aname"].(string)})
		}
		return nil
	}

	// 2. 缓存中没有数据从 mysql 中查找数据
	o := orm.NewOrm()
	var areas []models.Area
	num, err := o.QueryTable("Area").All(&areas)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	if num <= 0 {
		rsp.ErrNo = utils.RECODE_NODATA
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 3. 将查找到的数据存到缓存中
	// 将获取到的数据转化为 json 格式
	areasJson, _ := json.Marshal(areas)
	err = bm.Put("areaInfo", areasJson, 3600*time.Second)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 4. 将查找到的数据 按照 proto 的格式 发送给前端
	for _, value := range areas {
		rsp.Data = append(rsp.Data, &getarea.Response_Area{Aid: int32(value.Id), Aname: value.Name})
	}
	return nil
}
```

## FastDFS 安装

### 安装 FastDFS 依赖包

1）下载 libfastcommon.zip

下载地址：[https://github.com/happyfish100/libfastcommon/releases](https://github.com/happyfish100/libfastcommon/releases)

2）解压缩 libfastcommon.zip

3）进入到 libfastcommon 的目录中

4）执行 `./make.sh`

5）执行 `sudo ./make.sh install`

### 安装 FastDFS

1）下载 fastdfs.zip

下载地址：[https://github.com/happyfish100/fastdfs/releases](https://github.com/happyfish100/fastdfs/releases)

2）解压缩 fastdfs.zip

3）进入到 fastdfs 的目录中

4）执行 `./make.sh`

5）执行 `sudo ./make.sh install`

### 验证

```shell
ls -al /usr/bin/fdfs*
```

![image.png](https://i.loli.net/2020/06/22/e6xgFyE9URSaTZG.png)

### 配置 FastDFS

默认的配置文件地址在 `/etc/fdfs` 下，因为我们的项目需要，所以我们需要将配置文件拷贝到我们的 `conf` 文件夹下进配置。

```shell
$ cd /etc/fdfs
$ cp client.conf.sample storage.conf.sample tracker.conf.sample $GOPATH/src/ihome/ihomeWeb/conf
```

将配置文件的名字进行下修改

```shell
# 客户端
$ mv client.conf.sample client.conf
# 存储文件
$ mv storage.conf.sample storage.conf
# 跟踪器
$ mv tracker.conf.sample tracker.conf
```

准备文件夹在项目下创建文件夹

```shell
$ cd /home/lpgit/go/src/ihome
$ mkdir fastdfs
```

在 `fastdfs` 下创建四个文件夹

```shell
$ cd fastdfs
$ mkdir tracker client storage storage_data
```

配置 `tracker.conf`

```shell
# 8 行的 ip 地址设置
# bind an address of this host
# empty for bind all addresses of this host
bind_addr = 192.168.181.135（需要配置的ip）

# 23 行的的 log 日志设置
# the base path to store data and log files
base_path = /home/lpgit/go/src/ihome/fastdfs/tracker（log目录）
```

配置 `storage.conf`

```shell
# 15 行配置 ip
# bind an address of this host
# empty for bind all addresses of this host
bind_addr = 192.168.181.135

# 23 行的端口
# the storage server port
port = 22122

# 49 行的 log 日志设置
# the base path to store data and log files
base_path = /home/lpgit/go/src/ihome/fastdfs/storage（log目录）

# 129 行的文件存放设置
# store_path#, based 0, if store_path0 not exists, it's value is base_path
# the paths must be exist
store_path0 = /home/lpgit/go/src/ihome/fastdfs/storage_data（文件存放路径）
#store_path1=/home/yuqing/fastdfs2

# 116 行 tracker 的 ip 地址
# tracker_server can ocur more than once, and tracker_server format is "host:port", host can be hostname or ip address
tracker_server = 192.168.181.135:22122
```

配置 `client.conf` 日志

```shell
# 11 行的 log 日志地址
# the base path to store log files
base_path = /home/lpgit/go/src/ihome/fastdfs/client（log目录）
# 22 行追踪器的 ip
# tracker_server can ocur more than once, and tracker_server format is
# "host:port", host can be hostname or ip address
tracker_server = 192.168.181.135:22122
```

更新项目目录下的的 `server.sh` 文件

```shell
# 启动 redis 服务
redis-server ./conf/redis.conf
# 启动 trackerd
fdfs_trackerd /home/lpgit/go/src/ihome/ihomeWeb/conf/tracker.conf restart
# 启动 storaged
fdfs_storaged /home/lpgit/go/src/ihome/ihomeWeb/conf/storage.conf restart
```

启动 tracker 和 storage

```shell
$ cd $GOPATH/src/ihome/ihomeWeb
$ ./server.sh 
```

先找张图片测试以下，把图片放到 `ihomeWeb` 文件夹下

```shell
$ cd $GOPATH/src/ihome/ihomeWeb
$ fdfs_upload_file ./conf/client.conf test.jpeg
```

![image.png](https://i.loli.net/2020/06/22/koQlTpIOvz5Ay6h.png)

## 获取验证码图片

### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/imagecode/:uuid
# data:
no input data

# Response
# 返回成功：
{
	二进制图片
}
# 注册失败：
{
	"errno": "4001", //状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetImageCd
```

修改 GetImageCd 文件夹下 proto 的文件夹下的 example 名字为 getimagecd

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetImageCd/proto$ tree
.
└── getimagecd
    └── getimagecd.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PutComment;

service PutComment {
  rpc PutComment(Request) returns (Response) {}
}

message Request {
  string SessionId = 1;
  // 订单id
  string OrderId = 2;
  // 订单评论
  string OrderComment = 3;
}

message Response {
  string ErrNo = 1;
  string ErrMsg = 2;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetImageCd
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getimagecd/getimagecd.proto
```

### 在 Web 中添加路由

```go
// 获取图片验证码
rou.GET("/api/v1.0/imagecode/:uuid", handler.GetImageCd)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/afocus/captcha"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"ihome/ihomeWeb/utils"
	"image/color"
	"time"

	getimagecd "ihome/GetImageCd/proto/getimagecd"
)

type Server struct{}

func (e *Server) GetImageCd(ctx context.Context, req *getimagecd.Request, rsp *getimagecd.Response) error {
	// 成功返回
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	// 创建一个对象
	cap := captcha.New()
	if err := cap.SetFont("comic.ttf"); err != nil {
		panic(err.Error())
	}
	// 设置图片的大小
	cap.SetSize(90, 41)
	// 设置干扰强度
	cap.SetDisturbance(captcha.MEDIUM)
	// 设置前景色，  可以设置多个 随机替换文字颜色， 默认黑色
	cap.SetFrontColor(color.RGBA{255, 255, 255, 255})
	// 设置背景色， 可以设置多个 随机替换背景色， 默认 白色
	cap.SetBkgColor(color.RGBA{255, 0, 0, 255}, color.RGBA{0, 0, 255, 255}, color.RGBA{0, 153, 0, 255})
	// 生成图片， 返回图片和字符串(图片内容的文本形式)
	img, str := cap.Create(4, captcha.NUM)
	// 解引用
	b := *img
	c := *(b.RGBA)

	rsp.Stride = int64(c.Stride)
	rsp.Pix = []byte(c.Pix)
	rsp.Max = &example.Response_Point{X: int64(c.Rect.Max.X), Y: int64(c.Rect.Max.Y)}
	rsp.Min = &example.Response_Point{X: int64(c.Rect.Min.X), Y: int64(c.Rect.Min.Y)}

	// 存储到缓存中： 将 uuid 与 验证码的文本形式 存储在 redis 中
	// 初始化缓存全局变量的对象
	redisConf := map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	}
	redisConfJson, _ := json.Marshal(redisConf)

	// 连接 redis
	bm, err := cache.NewCache("redis", string(redisConfJson))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 验证码进行 10 分钟的缓存
	_ = bm.Put(req.Uuid, str, 600*time.Second)

	return nil
}
```

### web 下的 handler

```go
// 获取图片验证码
func GetImageCd(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
	// 获取前端发送过来的图片唯一标识码
	uuid := ps.ByName("uuid")
	// 创建服务
	server := grpc.NewService()
	// 初始化服务
	server.Init()
	// 连接服务
	exampleCLient := GETIMAGECD.NewExampleService("go.micro.srv.GetImageCd", server.Client())
	rsp, err := exampleCLient.GetImageCd(context.TODO(), &GETIMAGECD.Request{
		Uuid: uuid,
	})
	if err != nil {
		http.Error(w, err.Error(), 500)
		return
	}

	// 处理图片信息
	var img image.RGBA
	img.Pix = []uint8(rsp.Pix)
	img.Stride = int(rsp.Stride)
	img.Rect.Max.X = int(rsp.Max.X)
	img.Rect.Max.Y = int(rsp.Max.Y)
	img.Rect.Min.X = int(rsp.Min.X)
	img.Rect.Min.Y = int(rsp.Min.Y)

	var image captcha.Image
	image.RGBA = &img

	// 将图片发送给前端
	png.Encode(w, image)
}
```

## 获取短信验证码



### 流程



### 接口

```shell
# Request:
method: GET

# 111表示的是手机号
url:api/v1.0/smscode/:mobile
url:api/v1.0/smscode/111? text=248484&id=9cd8faa9-5653-4f7c-b653-0a58a8a98c81
data:no input data

# Response
# 返回成功：
{
	"errno": "0", //状态码
	"errmsg":"ok"
}
# 注册失败：
{
	"errno": "4001", //状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetSmscd
```

修改 GetSmscd 文件夹下 proto 的文件夹下的 example 名字为 getsmscd

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetSmscd/proto$ tree
.
└── getsmscd
    └── getsmscd.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetSmscd;

service GetSmscd {
	rpc GetSmscd(Request) returns (Response) {}
}

message Request {
	// 手机号
	string Mobile = 1;
	// 验证码
	string Text = 2;
	// uuid
	string Uuid = 3;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetSmscd
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getsmscd/getsmscd.proto
```

### 在 Web 中添加路由

```go
/ 获取短信验证码
rou.GET("/api/v1.0/smscode/:mobile", handler.GetSmscd)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	"github.com/garyburd/redigo/redis"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"github.com/micro/go-log"
	getsmscd "ihome/GetSmscd/proto/getsmscd"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"math/rand"
	"time"
)

type Server struct{}

func (e *Server) GetSmscd(ctx context.Context, req *getsmscd.Request, rsp *getsmscd.Response) error {
	// 初始化返回正确的返回值
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	// 验证手机号是否已经存在于数据库中
	o := orm.NewOrm()
	var user models.User
	user.Mobile = req.Mobile
	err := o.Read(&user)
	if err == nil {
		// 查到存在此手机号，返回 用户已存在
		rsp.ErrNo = utils.RECODE_DATAEXIST
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 验证 uuid 缓存
	// 连接 redis 数据库
	redisConf := map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	}
	redisConfJson, _ := json.Marshal(redisConf)
	// 连接 redis 数据库， 创建句柄
	bm, err := cache.NewCache("redis", string(redisConfJson))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	uuidCache := bm.Get(req.Uuid)
	if uuidCache == nil {
		// 缓存中没有 uuid
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	uuidStr, _ := redis.String(uuidCache, nil)
	if req.Text != uuidStr {
		// 图片验证码错误
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// ============    设置 短信    ============
	// 生成一个随机数， 用于短信验证码
	r := rand.New(rand.NewSource(time.Now().UnixNano()))
	randomCode := r.Intn(99999) + 10001

	fmt.Println("短信验证码：", randomCode)

	// 通过手机号对验证短信进行缓存
	err = bm.Put(req.Mobile, randomCode, time.Second*600)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	return nil
}
```

### web 下的 handler

```go
// 获取手机短信验证码
func GetSmscd(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
	// ============    获取数据    ============
	// 获取手机号
	mobile := ps.ByName("mobile")
	// 获取 uuid
	uuid := r.URL.Query()["id"][0]
	// 获取 图片验证码
	imageCode := r.URL.Query()["text"][0]

	// ============    处理数据    ============
	// 手机号 进行正则匹配
	// 创建正则对象
	regex := regexp.MustCompile(`0?(13|14|15|17|18|19)[0-9]{9}`)
	isMobile := regex.MatchString(mobile)
	if isMobile == false {
		// 手机号格式错误, 返回
		response := map[string]interface{}{
			"errno":  utils.RECODE_MOBILEERR,
			"errmsg": utils.RecodeText(utils.RECODE_MOBILEERR),
		}
		// 设置返回数据格式
		w.Header().Set("Content-Type", "application/json")
		// 将错误发送给前端
		if err := json.NewEncoder(w).Encode(response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	// ============    创建服务    ============
	server := grpc.NewService()
	server.Init()

	// 调用服务
	exampleClient := GETSMSCD.NewExampleService("go.micro.srv.GetSmscd", server.Client())
	rsp, err := exampleClient.GetSmscd(context.TODO(), &GETSMSCD.Request{
		Mobile: mobile,
		Uuid:   uuid,
		Text:   imageCode,
	})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	// 返回
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
	}
	w.Header().Set("Content-Type", "application/json")
	// 将数据返回给前端
	if err := json.NewEncoder(w).Encode(response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
}
```

## 注册请求



## 获取 Session 信息



## 登录请求







## 退出请求

### 创建命令

```shell
$ micro new --type "srv" ihome/DeleteSession
```

修改 DeleteSession 文件夹下 proto 的文件夹下的 example 为 deletesession

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/DeleteSession/proto$ tree
.
└── deletesession
    └── deletesession.proto
    
1 directory, 1 file
```

### 流程

**用户退出**：/api/v1.0/session  [delete]



### 接口

```shell
# Request:
method: DELETE
url:api/v1.0/session

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg":"OK",
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.DeleteSession;

service DeleteSession {
	rpc DeleteSession(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/DeleteSession
$ protoc --proto_path=. --go_out=. --micro_out=. proto/deletesession/deletesession.proto
```

### 在 Web 中添加路由

```go
// 退出登录
rou.DELETE("/api/v1.0/session", handler.DeleteSession)
```

### Web 下的 handler

```go
func DeleteSession(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取 sessionId
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		response := map[string]interface{} {
			"errno": utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
	}

	// 连接 退出登录 服务
	service := grpc.NewService()
	service.Init()
	deleteSessionClient := deletesession.NewDeleteSessionService("go.micro.srv.DeleteSession", service.Client())
	rsp, err := deleteSessionClient.DeleteSession(context.TODO(), &deletesession.Request{
		SessionId: userLoginSession.Value,
	})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	/* 处理数据 */

	http.SetCookie(w, &	http.Cookie{
		Name: "userLogin",
		Path: "/",
		MaxAge: -1,
	})

	/* 返回数据 */
	response := map[string]interface{} {
		"errno": rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
	}
	w.Header().Set("Content-Type", "application/json")

	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
	return
}
```

### srv 下的 handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	"ihome/ihomeWeb/utils"

	deletesession "ihome/DeleteSession/proto/deletesession"
)

type Example struct{}

func (e *Example) DeleteSession(ctx context.Context, req *deletesession.Request, rsp *deletesession.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId
	//req.SessionId

	/* 处理数据 */
	// 连接 redis 数据库
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 删除缓存中的数据
	bm.Delete(req.SessionId + "name")
	bm.Delete(req.SessionId + "userId")
	bm.Delete(req.SessionId + "mobile")

	return nil
}
```

## 获取用户信息

### 创建命令

```shell
$ micro new --type "srv" ihome/GetUserInfo
```

修改 GetUserInfo文件夹下 proto 的文件夹下的 example 为 getuserinfo



### 流程







### 接口

```shell
# Request:
method: GET
url:api/v1.0/user

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"user_id": 1,
		"name": "Panda",
		"mobile": "110",
		"real_name": "熊猫",
		"id_card": "210112244556677",
		"avatar_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png"
	}
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetUserInfo;

service GetUserInfo {
	rpc GetUserInfo(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
}

message Response {
	// 错误码
	string ErrNo = 1;
	// 错误信息
	string ErrMsg = 2;
	// 用户 id
	int64 UserId = 3;
	// 用户名
	string UserName = 4;
	// 手机号
	string Mobile = 5;
	// 真实姓名
	string RealName = 6;
	// 身份证号
	string IdCard = 7;
	// 头像地址
	string AvatarUrl = 8;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetUserInfo
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getuserinfo/getuserinfo.proto
```

### 在 Web 中添加路由

```go
// 获取用户信息
rou.GET("/api/v1.0/user", handler.GetUserInfo)
```

### srv 下的  handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	getuserinfo "ihome/GetUserInfo/proto/getuserinfo"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
)

type Server struct{}

func (e *Server) GetUserInfo(ctx context.Context, req *getuserinfo.Request, rsp *getuserinfo.Response) error {
	/* 初始化返回值 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId + "userId"，可得到 userId
	// 连接 redis 数据库
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	/* 处理数据 */
	// 从数据库中查询该用户
	o := orm.NewOrm()
	var user models.User
	user.Id = userId
	err = o.Read(&user)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 返回数据 */
	rsp.UserId = int64(user.Id)
	rsp.UserName = user.Name
	rsp.Mobile = user.Mobile
	rsp.RealName = user.RealName
	rsp.IdCard = user.IdCard
	rsp.AvatarUrl = user.AvatarUrl
	return nil
}
```

### Web 下的 handler

```go
func GetUserInfo(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取 sessionId
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		// 获取 session 失败，直接返回
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	/* 处理数据 */
	// 连接 服务
	service := grpc.NewService()
	service.Init()

	getUserInfoClient := getuserinfo.NewGetUserInfoService("go.micro.srv.GetUserInfo", service.Client())
	rsp, err := getUserInfoClient.GetUserInfo(context.TODO(), &getuserinfo.Request{
		SessionId: userLoginSession.Value,
	})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	data := make(map[string]interface{})
	// 将从服务端得到的数据发送给前端
	data["user_id"] = rsp.UserId
	data["name"] = rsp.UserName
	data["mobile"] = rsp.Mobile
	data["real_name"] = rsp.RealName
	data["id_card"] = rsp.IdCard
	data["avatar_url"] = utils.AddDomain2Url(rsp.AvatarUrl)

	/* 返回数据 */
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
	return
}
```

## 上传用户头像

### 创建命令

```shell
$ micro new --type "srv" ihome/PostAvatar
```

修改 PostAvatar 文件夹下 proto 的文件夹下的 example 为 postavatar

```shell

```

### 流程



### 接口

```shell
# Request:
method: POST
url:api/v1.0/user/avatar

# data:
图片的二进制数据

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
	"avatar_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1n6_LAOB04AADexS5wJKs662.png" //图片地址需要进行拼接
	}
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 封装 fastDFS 操纵函数

`ihomeWeb/models/models.go`

```go
package models

import (
	"github.com/astaxie/beego"
	"github.com/astaxie/beego/logs"
	"github.com/weilaihui/fdfs_client"
)

// 通过文件名的方式进行上传
func UploadByFilename(filename string) (GroupName, RemoteFileId string, err error) {
	GroupName = ""
	RemoteFileId = ""
	// 通过配置文件创建 fdfs 对象
	fdfsClient, err := fdfs_client.NewFdfsClient("/home/lpgit/go/src/ihome/ihomeWeb/conf/client.conf")
	if err != nil {
		logs.Info(err.Error())
		return
	}
	uploadFileResponse, err := fdfsClient.UploadByFilename(filename)
	if err != nil {
		logs.Info(err.Error())
		return
	}

	return uploadFileResponse.GroupName, uploadFileResponse.RemoteFileId, nil
}

// 操作 fdfs 上传二进制文件
func UploadByBuffer(fileBuffer []byte, fileExtName string) (GroupName, RemoteFileId string, err error) {
	GroupName = ""
	RemoteFileId = ""

	// 通过配置文件创建 fdfs 对象
	fdfsClient, err := fdfs_client.NewFdfsClient("/home/lpgit/go/src/ihome/ihomeWeb/conf/client.conf")
	if err != nil {
		logs.Info(err.Error())
		return
	}
	uploadFileResponse, err := fdfsClient.UploadByBuffer(fileBuffer, fileExtName)
	if err != nil {
		logs.Info(err.Error())
		return
	}

	return uploadFileResponse.GroupName, uploadFileResponse.RemoteFileId, nil
}
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PostAvatar;

service PostAvatar {
  rpc PostAvatar(Request) returns (Response) {}
}

message Request {
  // sessionId
  string SessionId = 1;
  // 二进制图片
  bytes Avatar = 2;
  // 图片大小
  int64 FileSize = 3;
  // 图片名字
  string FileName = 4;
}

message Response {
  string ErrNo = 1;
  string ErrMsg = 2;
  string AvatarUrl = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PostAvatar
$ protoc --proto_path=. --go_out=. --micro_out=. proto/postavatar/postavatar.proto
```

### 在 Web 中添加路由

```go
// 上传用户头像
rou.POST("/api/v1.0/user/avatar", handler.PostAvatar)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"path"

	postavatar "ihome/PostAvatar/proto/postavatar"
)

type Server struct{}

func (e *Server) PostAvatar(ctx context.Context, req *postavatar.Request, rsp *postavatar.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取文件的后缀名
	fileExt := path.Ext(req.FileName)

	// 连接 redis 数据库
	redisConfig, _ := json.Marshal(map[string]interface{}{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	// 获取 sessionId
	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	// 从数据库中找到对应用户
	o := orm.NewOrm()
	var user models.User
	user.Id = userId

	/* 处理数据 */
	// 上传数据
	_, RemoteFileId, err := models.UploadByBuffer(req.Avatar, fileExt[1:])
	if err != nil {
		rsp.ErrNo = utils.RECODE_IOERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	user.AvatarUrl = RemoteFileId
	_, err = o.Update(&user, "AvatarUrl")
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 返回数据 */
	rsp.AvatarUrl = RemoteFileId
	return nil
}
```

### web 下的 handler

```go
// 上传用户头像
func PostAvatar(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取用户 sessionId, 查看登录信息
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		// 获取 session 失败, 返回前端数据
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	// 获取二进制图片，名字，大小
	avatarFile, avatarHeader, err := r.FormFile("avatar")
	if err != nil {
		response := map[string]interface{}{
			"errno":  utils.RECODE_IOERR,
			"errmsg": utils.RecodeText(utils.RECODE_IOERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	/* 处理数据 */
	// 存储文件（二进制）
	fileBuffer := make([]byte, avatarHeader.Size)
	// 将文件读到 fileBuffer 里
	_, err = avatarFile.Read(fileBuffer)
	if err != nil {
		response := map[string]interface{}{
			"errno":  utils.RECODE_IOERR,
			"errmsg": utils.RecodeText(utils.RECODE_IOERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	// 连接 上传头像 服务， 传入数据
	service := grpc.NewService()
	service.Init()

	postAvatarClient := postavatar.NewPostAvatarService("go.micro.srv.PostAvatar", service.Client())
	rsp, err := postAvatarClient.PostAvatar(context.TODO(), &postavatar.Request{
		SessionId: userLoginSession.Value,
		Avatar:    fileBuffer,
		FileName:  avatarHeader.Filename,
		FileSize:  avatarHeader.Size,
	})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	/* 返回数据 */
	// 给前端传输数据
	data := make(map[string]interface{})
	// url 拼接图片地址
	data["avatar_url"] = utils.AddDomain2Url(rsp.AvatarUrl)
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
	return
}
```

## 更新用户名

### 创建命令

```shell
$ micro new --type "srv" "ihome/PutUserInfo"
```

修改 PutUserInfo 文件夹下 proto 的文件夹下的 example 名字为 putuserinfo

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/PutUserInfo/proto$ tree
.
└── putuserinfo
    └── putuserinfo.proto

1 directory, 1 files
```

### 流程



### 接口

```shell
# Request:
method: PUT
url:api/v1.0/user/name
# data:
{
	"name":"conan"
}

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
	"name": "conan"
	}
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PutUserInfo;

service PutUserInfo {
	rpc PutUserInfo(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
	string UserName = 2;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	string UserName = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PutUserInfo
$ protoc --proto_path=. --go_out=. --micro_out=. proto/putuserinfo/putuserinfo.proto
```

### 在 Web 中添加路由

```go
// 更新用户名
rou.PUT("/api/v1.0/user/name", handler.PutUserInfo)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"time"

	putuserinfo "ihome/PutUserInfo/proto/putuserinfo"
)

type Server struct{}

func (e *Server) PutUserInfo(ctx context.Context, req *putuserinfo.Request, rsp *putuserinfo.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId, 从 redis 中获取对应用户id， 在 mysql 中更新信息
	//sessionId := req.SessionId
	// 连接 redis
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	// 获取用户名
	//userName := req.UserName

	/* 处理数据 */
	// 去数据库更新用户名
	var user models.User
	o := orm.NewOrm()
	user.Id = userId
	user.Name = req.UserName
	_, err = o.Update(&user, "Name")
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 更新 session
	bm.Put(req.SessionId+"userId", user.Id, time.Second*3600)
	bm.Put(req.SessionId+"name", user.Name, time.Second*3600)
	bm.Put(req.SessionId+"mobile", user.Mobile, time.Second*3600)

	/* 返回数据 */
	rsp.UserName = user.Name
	return nil
}
```

### web 下的 handler

```go
// 更新用户名
func PutUserInfo(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取前端提交的数据
	var request map[string]interface{}
	if err := json.NewDecoder(r.Body).Decode(&request); err != nil {
		http.Error(w, err.Error(), 500)
		return
	}
	// 获取 sessionId
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	/* 处理数据 */
	// 连接 更新用户名 服务
	service := grpc.NewService()
	service.Init()

	putUserInfoClient := putuserinfo.NewPutUserInfoService("go.micro.srv.PutUserInfo", service.Client())
	rsp, err := putUserInfoClient.PutUserInfo(context.TODO(), &putuserinfo.Request{
		SessionId: userLoginSession.Value,
		UserName:  request["name"].(string),
	})
	if err != nil {
		http.Error(w, err.Error(), 500)
		return
	}

	/* 返回数据 */
	// 接收回发的数据
	data := map[string]interface{}{
		"name": rsp.UserName,
	}

	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 501)
		return
	}
	return
}
```

## 检查用户实名认证

### 创建命令

```shell
$ micro new --type "srv" ihome/GetUserAuth
```





### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/user/auth

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"user_id": 1,
		"name": "conan",
		"password": "123123",
		"mobile": "111",
		"real_name": "李培冠",
		"id_card": "123456789123456789",
		"avatar_url":
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1n7It2ANn1dAADexS5wJKs808.png"
	}
}

 #返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```



### 编写 proto 文件

```protobuf

```

```shell
$ cd /home/lpgit/go/src/ihome/GetUserAuth
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getuserauth/getuserauth.proto
```







### 在 Web 中添加路由



### srv 下的handler

```go
func (e *Server) GetUserAuth(ctx context.Context, req *getuserauth.Request, rsp *getuserauth.Response) error {
	/* 初始化返回值 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId + "userId"，可得到 userId
	// 连接 redis 数据库
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	/* 处理数据 */
	// 从数据库中查询该用户
	o := orm.NewOrm()
	var user models.User
	user.Id = userId
	err = o.Read(&user)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 返回数据 */
	rsp.UserId = int64(user.Id)
	rsp.UserName = user.Name
	rsp.Mobile = user.Mobile
	rsp.RealName = user.RealName
	rsp.IdCard = user.IdCard
	rsp.AvatarUrl = user.AvatarUrl
	return nil
}
```



### web 下的 handler





## 更新实名认证信息

### 创建命令





### 流程



### 接口

```shell
# Request:
method: POST
url:api/v1.0/user/auth
# data:
{
	real_name: "李培冠",
	id_card: "123456789123456789"
}

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功"
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```



### 编写 proto 文件

```shell
$ cd /home/lpgit/go/src/ihome/PostUserAuth
$ protoc --proto_path=. --go_out=. --micro_out=. proto/postuserauth/postuserauth.proto
```



### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler





## 获取当前用户已发布房源信息

### 创建命令

```shell
$ micro new -type "srv" ihome/GetUserHouses
```

修改 GetUserHouses 文件夹下 proto 的文件夹下的 example 名字为 getuserhouses

```shell

```





### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/user/houses

# data:
no input data
# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"houses": [
			{
			"address": "西三旗桥东",
			"area_name": "昌平区",
			"ctime": "2017-11-06 11:16:24",
			"house_id": 1,
			"img_url": 		"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052jpg",
			"order_count": 0,
			"price": 100,
			"room_count": 2,
			"title": "上奥世纪中心",
			"user_avatar":
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"
			},
			{
			"address": "北清路郑上路",
			"area_name": "顺义区",
			"ctime": "2017-11-06 11:38:54",
			"house_id": 2,
			"img_url":
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBKtmAC8y8AAZcKg5PznU817.jpg",
			"order_count": 0,
			"price": 1000,
			"room_count": 1,
			"title": "修正大厦302教室",
			"user_avatar":
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"
			}
		]
	}
}
# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetUserHouses;

service GetUserHouses {
	rpc GetUserHouses(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	bytes Data = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetUserHouses
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getuserhouses/getuserhouses.proto
```

### 在 Web 中添加路由

```go
// 获取当前用户已发布房源信息
rou.GET("/api/v1.0/user/houses", handler.GetUserHouses)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"

	getuserhouses "ihome/GetUserHouses/proto/getuserhouses"
)

type Server struct{}

func (e *Server) GetUserHouses(ctx context.Context, req *getuserhouses.Request, rsp *getuserhouses.Response) error {
	/* 初始化返回值 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId: req.SessionId， 找到用户id
	// 连接 redis 数据库
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	/* 处理数据 */
	o := orm.NewOrm()
	var houses []models.House
	num, err := o.QueryTable("House").Filter("User__Id", userId).All(&houses)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	if num <= 0 {
		rsp.ErrNo = utils.RECODE_NODATA
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 返回数据 */
	rsp.Data, _ = json.Marshal(houses)
	return nil
}
```

### web 下的 handler

```go
// 获取当前用户已发布房源信息
func GetUserHouses(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取 sessionId 传给服务端
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		// 用户未登录
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	/* 处理数据 */
	// 连接服务
	service := grpc.NewService()
	service.Init()

	getUserHousesClient := getuserhouses.NewGetUserHousesService("go.micro.srv.GetUserHouses", service.Client())
	rsp, err := getUserHousesClient.GetUserHouses(context.TODO(), &getuserhouses.Request{
		SessionId: userLoginSession.Value,
	})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	var houses []models.House
	data := make(map[string]interface{})

	_ = json.Unmarshal(rsp.Data, &houses)
	data["houses"] = houses

	/* 返回数据 */
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 501)
		return
	}

	return
}
```

## 发布房源信息

### 创建命令

```shell
$  micro new --type "srv" ihome/PostHouses
```

修改 PostHouses 文件夹下 proto 的文件夹下的 example 名字为 posthouses



### 流程



### 接口



### 编写 proto 文件

```protobuf

```

```shell
$ cd /home/lpgit/go/src/ihome/PostHouses
$ protoc --proto_path=. --go_out=. --micro_out=. proto/posthouses/posthouses.proto
```





### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler





## 上传房源图片

### 创建命令

```shell
$ micro new --type "srv" ihome/PostHousesImage
```

修改 PostHouses 文件夹下 proto 的文件夹下的 example 名字为 posthousesimage



### 流程



### 接口



### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PostHousesImage;

service PostHousesImage {
	rpc PostHousesImage(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
	// 房屋 Id
	string HouseId = 2;
	// 图片名字
	string FileName = 3;
	// 图片大小
	string FileSize = 4;
	// 图片
	bytes Image = 5;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	string Url = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PostHousesImage
$ protoc --proto_path=. --go_out=. --micro_out=. proto/posthousesimage/posthousesimage.proto
```



### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler





## 获取房源详细信息

### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/houses/:id
例：url:api/v1.0/houses/1

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"house": {
		"acreage": 80,
		"address": "西三旗桥东",
		"beds": "2双人床",
		"capacity": 3,
		"comments": [
			{
			"comment": "评论的内容",
			"ctime": "2017-11-12 12:30:30",
			"user_name": "评论人的姓名"
			},
			{
			"comment": "评论的内容",
			"ctime": "2017-11-12 12:30:30",
			"user_name": "评论人的姓名"
			}
		],
		"deposit": 200,
		"facilities": [9,11,13,16,19,20,21,23],
		"hid": 1,
		"img_urls": [
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052.jpg",
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJZmAYqGWAAaInSzecQ230.jpg"
		],
		"max_days": 30,
		"min_days": 1,
		"price": 100,
		"room_count": 2,
		"title": "上奥世纪中心",
		"unit": "3室3厅",
		"user_avatar":
"http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png",
		"user_id": 1,
		"user_name": "Panda"
		},
	"user_id": 1
	}
}

 # 返回失败：
{
	"errno": "400x", // 状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetHouseInfo
```

修改 GetHouseInfo 文件夹下 proto 的文件夹下的 example 名字为 gethouseinfo

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetHouseInfo/proto$ tree
.
└── gethouseinfo
    └── gethouseinfo.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetHouseInfo;

service GetHouseInfo {
  rpc GetHouseInfo(Request) returns (Response) {}
}

message Request {
  string SessionId = 1;
}

message Response {
  string ErrNo = 1;
  string ErrMsg = 2;
  bytes  Data = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetHouseInfo
$ protoc --proto_path=. --go_out=. --micro_out=. proto/gethouseinfo/gethouseinfo.proto
```

### 在 Web 中添加路由

```go
// 获取房源详细信息
rou.GET("/api/v1.0/houses/:id", handler.GetHouseInfo)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	gethouseinfo "ihome/GetHouseInfo/proto/gethouseinfo"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"strconv"
	"time"
)

type Server struct{}

func (e *Server) GetHouseInfo(ctx context.Context, req *gethouseinfo.Request, rsp *gethouseinfo.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// houseId
	houseId := req.HouseId

	// 用户sessionId： req.SessionId
	sessionId := req.SessionId
	// 连接 redis
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	// 获取用户id
	userIdTemp := bm.Get(sessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	/* 处理数据 */
	// 从 redis 中获取房屋数据， 没有则去数据库中获取并添加到缓存中
	houseInfo := bm.Get("houseInfo" + houseId)
	if houseInfo != nil {
		// 缓存中有数据
		rsp.UserId = strconv.Itoa(userId)
		rsp.HouseInfo = houseInfo.([]byte)
		return nil
	}

	// 缓存中没有数据， 在数据库中添加
	var house models.House
	o := orm.NewOrm()
	house.Id, _ = strconv.Atoi(houseId)
	_ = o.Read(&house)
	// 关联查询
	o.LoadRelated(&house, "Area")
	o.LoadRelated(&house, "User")
	o.LoadRelated(&house, "Images")
	o.LoadRelated(&house, "Facilities")

	// 将查询到的结果存到缓存中
	houseMarshal, _ := json.Marshal(house)
	_ = bm.Put("houseInfo"+houseId, houseMarshal, time.Second*3600)

	/* 返回数据 */
	rsp.UserId = strconv.Itoa(userId)
	rsp.HouseInfo = houseMarshal

	return nil
}
```

### web 下的 handler

```go
// 获取房源详细信息
func GetHouseInfo(w http.ResponseWriter, r *http.Request, ps httprouter.Params) {
	/* 获取数据 */
	// 获取房源id
	houseId := ps.ByName("id")
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
	}

	/* 处理数据 */
	// 连接服务
	service := grpc.NewService()
	service.Init()

	getHouseInfoClient := gethouseinfo.NewGetHouseInfoService("go.micro.srv.GetHouseInfo", service.Client())
	rsp, err := getHouseInfoClient.GetHouseInfo(context.TODO(), &gethouseinfo.Request{
		SessionId: userLoginSession.Value,
		HouseId:   houseId,
	})
	if err != nil {
		http.Error(w, err.Error(), 500)
		return
	}

	data := make(map[string]interface{})
	var house models.House
	json.Unmarshal(rsp.HouseInfo, &house)
	data["house"] = house.ToOneHouseDesc()
	data["user_id"] = rsp.UserId

	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 501)
		return
	}

	return
}
```

## 获取首页动画图片

### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/houses/index

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"houses": [
			{
			"house_id": this.Id,
			"title": this.Title,
			"price": this.Price,
			"area_name": this.Area.Name,
			"img_url": utils.AddDomain2Url(this.Index_image_url),
			"room_count": this.Room_count,
			"order_count": this.Order_count,
			"address": this.Address,
			"user_avatar": utils.AddDomain2Url(this.User.Avatar_url),
			"ctime": this.Ctime.Format("2006-01-02 15:04:05"),
			},
			{
			"house_id": this.Id,
			"title": this.Title,
			"price": this.Price,
			"area_name": this.Area.Name,
			"img_url": utils.AddDomain2Url(this.Index_image_url),
			"room_count": this.Room_count,
			"order_count": this.Order_count,
			"address": this.Address,
			"user_avatar": utils.AddDomain2Url(this.User.Avatar_url),
			"ctime": this.Ctime.Format("2006-01-02 15:04:05"),
			}
		],
	}
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetIndex
```

修改 GetIndex文件夹下 proto 的文件夹下的 example 名字为 getindex

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetIndex/proto$ tree
.
└── getindex
    └── getindex.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetIndex;

service GetIndex {
	rpc GetIndex(Request) returns (Response) {}
}

message Request {
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	bytes Data = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetIndex
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getindex/getindex.proto
```

### 在 Web 中添加路由

```go
// 获取首页轮播图
rou.GET("/api/v1.0/house/index", handler.GetIndex)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	getindex "ihome/GetIndex/proto/getindex"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"time"
)

type Server struct{}

func (e *Server) GetIndex(ctx context.Context, req *getindex.Request, rsp *getindex.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 先从缓存中获取， 没有则从数据库获取并加入缓存
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	homePageData := bm.Get("homePageData")
	if homePageData != nil {
		// 缓存中有数据, 直接将二进制数据发送给客户端
		rsp.Data = homePageData.([]byte)
		return nil
	}

	// 缓存中没有数据， 从数据库中查询
	o := orm.NewOrm()
	var houses []models.House
	_, err = o.QueryTable("House").Limit(models.HomePageMaxHouses).All(&houses)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 处理数据 */
	var data []interface{}
	for _, house := range houses {
		o.LoadRelated(&house, "Area")
		o.LoadRelated(&house, "User")
		o.LoadRelated(&house, "Images")
		o.LoadRelated(&house, "Facilities")

		data = append(data, house.ToHouseInfo())
	}

	homePageData, _ = json.Marshal(data)
	bm.Put("homePageData", homePageData, time.Second*3600)

	/* 返回数据 */
	rsp.Data = homePageData.([]byte)

	return nil
}
```

### web 下的 handler

```go
// 获取首页轮播图
func GetIndex(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */

	/* 处理数据 */
	// 连接服务
	service := grpc.NewService()
	service.Init()

	getIndexClient := getindex.NewGetIndexService("go.micro.srv.GetIndex", service.Client())
	rsp, err := getIndexClient.GetIndex(context.TODO(), &getindex.Request{})
	if err != nil {
		http.Error(w, err.Error(), 502)
		return
	}

	var data []interface{}
	json.Unmarshal(rsp.Data, &data)

	/* 返回数据 */
	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-TYpe", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 503)
		return
	}
	return
}
```

## 搜索房源

### 流程



### 接口

```shell
# Request:
method: GET
#adi表示地区编号、sd表示起始日期、ed表示结束日期、sk表示查询方式、p表示页码
url:api/v1.0/houses?aid=5&sd=2017-11-12&ed=2017-11-30&sk=new&p=1

# data:
no input data

# Response
# 返回成功：
{
    "errno":  "0",
    "errmsg": "成功",
    "data": {
    "current_page": 1,
    "houses": [
    {
    "address":     "西三旗桥东",
    "area_name":   "昌平区",
    "ctime":       "2017-11-06 11:16:24",
    "house_id":    1,
    "img_url":     "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052.jpg",
    "order_count": 0,
    "price":       100,
    "room_count":  2,
    "title":       "上奥世纪中心13号楼",
    "user_avatar":
    "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"
    },
    {
    "address":     "西三旗桥东",
    "area_name":   "昌平区",
    "ctime":       "2017-11-06 11:16:24",
    "house_id":    1,
    "img_url":     "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052.jpg",
    "order_count": 0,
    "price":       100,
    "room_count":  2,
    "title":       "上奥世纪中心18号楼",
    "user_avatar":
    "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBLFeALIEjAADexS5wJKs340.png"
    }
    ],
    "total_page": 1
    }
}
# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/GetHouses
```

修改 GetHouses 文件夹下 proto 的文件夹下的 example 名字为 gethouses

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/GetHouses/proto$ tree
.
└── gethouses
    └── gethouses.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetHouses;

service GetHouses {
  rpc GetHouses(Request) returns (Response) {}
}

message Request {
  // 地区编号
  string AreaId = 1;
  // 起始日期
  string StartDate = 2;
  // 结束日期
  string EndDate = 3;
  // 查询方式
  string SelectKey = 4;
  // 页码
  string PageNumber = 5;
}

message Response {
  string ErrNo = 1;
  string ErrMsg = 2;
  // 房屋信息
  bytes Houses = 3;
  // 当前页码
  int64 CurrentPage = 4;
  // 总页数
  int64 TotalPage = 5;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetHouses
$ protoc --proto_path=. --go_out=. --micro_out=. proto/gethouses/gethouses.proto
```

### 在 Web 中添加路由

```go
// 搜索房源
rou.GET("/api/v1.0/houses", handler.GetHouses)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/orm"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"strconv"

	gethouses "ihome/GetHouses/proto/gethouses"
)

type Server struct{}

func (e *Server) GetHouses(ctx context.Context, req *gethouses.Request, rsp *gethouses.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 地区id
	areaId := req.AreaId
	// 起始日期
	//startDate := req.StartDate
	// 结束日期
	//endDate := req.EndDate
	// 页码
	pageNumber, _ := strconv.Atoi(req.PageNumber)

	// 根据查询条件查询数据
	var houses []models.House
	o := orm.NewOrm()
	houseNum, err := o.QueryTable("House").Filter("Area__Id", areaId).All(&houses)
	if err != nil {
		rsp.ErrNo = utils.RECODE_PARAMERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 处理数据 */
	totalPage := (int(houseNum) / models.HouseListPageCapacity) + 1

	var houseList []interface{}
	for _, house := range houses {
		o.LoadRelated(&house, "Area")
		o.LoadRelated(&house, "User")
		o.LoadRelated(&house, "Images")
		o.LoadRelated(&house, "Facilities")

		houseList = append(houseList, house.ToHouseInfo())
	}

	/* 返回数据 */
	rsp.Houses, _ = json.Marshal(houseList)
	rsp.CurrentPage = int64(pageNumber)
	rsp.TotalPage = int64(totalPage)

	return nil
}
```

### web 下的 handler

```go
// 搜索房源
func GetHouses(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	areaId := r.URL.Query()["aid"][0]
	startDate := r.URL.Query()["sd"][0]
	endDate := r.URL.Query()["ed"][0]
	selectKey := r.URL.Query()["sk"][0]
	currentPage := r.URL.Query()["p"][0]

	/* 处理数据 */
	// 连接服务
	service := grpc.NewService()
	service.Init()

	getHousesClient := gethouses.NewGetHousesService("go.micro.srv.GetHouses", service.Client())
	rsp, err := getHousesClient.GetHouses(context.TODO(), &gethouses.Request{
		AreaId:     areaId,
		StartDate:  startDate,
		EndDate:    endDate,
		SelectKey:  selectKey,
		PageNumber: currentPage,
	})
	if err != nil {
		http.Error(w, err.Error(), 500)
		return
	}

	/* 返回数据 */
	var houseList []interface{}
	json.Unmarshal(rsp.Houses, &houseList)

	data := make(map[string]interface{})
	data["current_page"] = currentPage
	data["houses"] = houseList
	data["total_page"] = rsp.TotalPage

	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}

	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 501)
		return
	}
	return
}
```

## 提交订单

### 流程



### 接口

```shell
# Request:
method: POST
url:api/v1.0/orders
# data:
{
	"house_id": "1",
	"start_date": "2017-11-11 21:23:49",
	"end_date": "2017-11-12 21:23:49",
}

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
		"order_id":"1"
	}
}

# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```

### 创建命令

```shell
$ micro new --type "srv" ihome/PostOrders
```

修改 PostOrders 文件夹下 proto 的文件夹下的 example 名字为 postorders

```shell
lpgit@lpgit-virtual-machine:~/go/src/ihome/PostOrders/proto$ tree
.
└── postorders
    └── postorders.proto

1 directory, 1 files
```

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PostOrders;

service PostOrders {
	rpc PostOrders(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
	// 提交的订单信息
	bytes OrderInfo = 2;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	// 订单 id
	string OrderId = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PostOrders
$ protoc --proto_path=. --go_out=. --micro_out=. proto/postorders/postorders.proto
```

### 在 Web 中添加路由

```go
// 发布订单
rou.POST("/api/v1.0/orders", handler.PostOrders)
```

### srv 下的handler

```go
package handler

import (
	"context"
	"encoding/json"
	"github.com/astaxie/beego/cache"
	_ "github.com/astaxie/beego/cache/redis"
	"github.com/astaxie/beego/orm"
	_ "github.com/garyburd/redigo/redis"
	_ "github.com/gomodule/redigo/redis"
	"ihome/ihomeWeb/models"
	"ihome/ihomeWeb/utils"
	"strconv"
	"time"

	postorders "ihome/PostOrders/proto/postorders"
)

type Server struct{}

func (e *Server) PostOrders(ctx context.Context, req *postorders.Request, rsp *postorders.Response) error {
	/* 初始化返回数据 */
	rsp.ErrNo = utils.RECODE_OK
	rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)

	/* 获取数据 */
	// 获取 sessionId，以查找对应用户id
	// 连接 redis
	redisConfig, _ := json.Marshal(map[string]string{
		"key":   utils.G_server_name,
		"conn":  utils.G_redis_addr + ":" + utils.G_redis_port,
		"dbNum": utils.G_redis_dbnum,
	})
	bm, err := cache.NewCache("redis", string(redisConfig))
	if err != nil {
		rsp.ErrNo = utils.RECODE_SESSIONERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}
	userIdTemp := bm.Get(req.SessionId + "userId")
	userId := int(userIdTemp.([]uint8)[0])

	// 获取订单信息
	orderInfo := make(map[string]interface{})
	err = json.Unmarshal(req.OrderInfo, &orderInfo)
	if err != nil {
		rsp.ErrNo = utils.RECODE_REQERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	/* 处理数据 */
	// 检验数据合法性
	// 简单的进行判断是否为空
	if orderInfo["house_id"] == "" || orderInfo["start_date"] == "" || orderInfo["end_date"] == "" {
		rsp.ErrNo = utils.RECODE_REQERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 结束日期要在开始日期之后
	// 格式化日期
	startDate, _ := time.Parse("2006-01-02 15:04:05", orderInfo["start_time"].(string)+"00:00:00")
	endDate, _ := time.Parse("2006-01-02 15:04:05", orderInfo["end_time"].(string)+"00:00:00")
	if endDate.Before(startDate) {
		rsp.ErrNo = utils.RECODE_ROLEERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 计算出入住的天数
	days := endDate.Sub(startDate).Hours()/24 + 1

	// 根据订单信息中的房屋id，找到关联的房屋信息
	var house models.House
	o := orm.NewOrm()
	house.Id, _ = strconv.Atoi(orderInfo["house_id"].(string))
	o.Read(&house)

	// 确保当前用户不是房源信息的发布者
	o.LoadRelated(&house, "User")
	if userId == house.User.Id {
		rsp.ErrNo = utils.RECODE_ROLEERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	// 添加订单信息
	/*Amount、Status、Comment
	Ctime、Credit*/
	var user models.User
	user.Id = userId
	o.Read(&user)

	var order models.OrderHouse
	order.House = &house
	order.User = &user
	order.BeginDate = startDate
	order.EndDate = endDate
	order.Days = int(days)
	order.HousePrice = house.Price
	order.Amount = int(days) * house.Price
	order.Status = models.OrderStatusWaitAccept
	order.Credit = false

	_, err = o.Insert(&order)
	if err != nil {
		rsp.ErrNo = utils.RECODE_DBERR
		rsp.ErrMsg = utils.RecodeText(rsp.ErrNo)
		return nil
	}

	bm.Put(req.SessionId+"userId", userId, time.Second*3600)

	/* 返回数据 */
	rsp.OrderId = strconv.Itoa(order.Id)

	return nil
}
```

### web 下的 handler

```go
// 发布订单
func PostOrders(w http.ResponseWriter, r *http.Request, _ httprouter.Params) {
	/* 获取数据 */
	// 获取订单信息
	orderInfo, _ := ioutil.ReadAll(r.Body)

	// 获取 cookie
	userLoginSession, err := r.Cookie("userLogin")
	if err != nil {
		response := map[string]interface{}{
			"errno":  utils.RECODE_SESSIONERR,
			"errmsg": utils.RecodeText(utils.RECODE_SESSIONERR),
		}
		w.Header().Set("Content-Type", "application/json")
		if err := json.NewEncoder(w).Encode(&response); err != nil {
			http.Error(w, err.Error(), 503)
			return
		}
		return
	}

	/* 处理数据 */
	// 连接服务
	service := grpc.NewService()
	service.Init()

	postOrdersClient := postorders.NewPostOrdersService("go.micro.srv.PostOrders", service.Client())
	rsp, err := postOrdersClient.PostOrders(context.TODO(), &postorders.Request{
		SessionId: userLoginSession.Value,
		OrderInfo: orderInfo,
	})
	if err != nil {
		http.Error(w, err.Error(), 500)
		return
	}

	/* 返回数据 */
	data := make(map[string]interface{})
	data["order_id"] = rsp.OrderId

	response := map[string]interface{}{
		"errno":  rsp.ErrNo,
		"errmsg": rsp.ErrMsg,
		"data":   data,
	}
	w.Header().Set("Content-Type", "application/json")
	if err := json.NewEncoder(w).Encode(&response); err != nil {
		http.Error(w, err.Error(), 501)
		return
	}

	return
}
```

## 请求查看房东/租客订单信息

### 流程



### 接口

```shell
# Request:
method: GET
url:api/v1.0/user/orders?role=custom 备注:role=custom 为租客查看订单信息
url:api/v1.0/user/orders?role=landlord 备注:role=landlord 为房东查看被预定订单信息

# data:
no input data

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功",
	"data": {
	"orders": [
		{
		"amount": 200,
		"comment": "哈哈拒接",
		"ctime": "2017-11-11 21:23:49",
		"days": 2,
		"end_date": "2017-11-29 16:00:00",
		"img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052.jpg",
		"order_id": 3,
		"start_date": "2017-11-28 16:00:00",
		"status": "REJECTED",
		"title": "上奥世纪中心"
		},
		{
		"amount": 1500,
		"comment": "",
		"ctime": "2017-11-11 01:32:10",
		"days": 15,
		"end_date": "2017-11-24 16:00:00",
		"img_url": "http://101.200.170.171:9998/group1/M00/00/00/Zciqq1oBJYAL3m8AAS8K2x8TDE052.jpg",
		"order_id": 2,
		"start_date": "2017-11-10 16:00:00",
		"status": "WAIT_COMMENT",
		"title": "上奥世纪中心"
		},
		]
	}
}

 #返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```



### 创建命令

```shell
$ micro new --type "srv" ihome/GetUserOrder
```

修改 GetUserOrder 文件夹下 proto 的文件夹下的 example 名字为 getuserorder

### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.GetUserOrder;

service GetUserOrder {
	rpc GetUserOrder(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
	string Role = 2;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
	bytes Orders = 3;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/GetUserOrder
$ protoc --proto_path=. --go_out=. --micro_out=. proto/getuserorder/getuserorder.proto
```

### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler



## 房东同意/拒绝订单





### 流程



### 接口

```shell

```

### 创建命令

```shell
$ micro new --type "srv" ihome/PutOrders
```

修改 PutOrders 文件夹下 proto 的文件夹下的 example 名字为 putorders

```shell

```



### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PutOrders;

service PutOrders {
	rpc PutOrders(Request) returns (Response) {}
}

message Request {
	string SessionId = 1;
	// 订单 id
	string OrderId = 2;
	// 同意 or 拒绝
	string Action = 3;
}

message Response {
	string ErrNo = 1;
	string ErrMsg = 2;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PutOrders
$ protoc --proto_path=. --go_out=. --micro_out=. proto/putorders/putorders.proto
```

### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler



## 用户评价订单信息





### 流程



### 接口

```shell
# Request:
method: PUT
# 2表示订单id
url:api/v1.0/orders/2/comment
url:api/v1.0/orders/:id/comment
# data:
{
	order_id: "2",
	comment: "烂房子！"
}

# Response
# 返回成功：
{
	"errno": "0",
	"errmsg": "成功"
}
# 返回失败：
{
	"errno": "400x", //状态码
	"errmsg":"状态错误信息"
}
```





### 创建命令

```shell
$ micro new --type "srv" ihome/PutComment
```

修改 PutComment 文件夹下 proto 的文件夹下的 example 名字为 putcomment



### 编写 proto 文件

```protobuf
syntax = "proto3";

package go.micro.srv.PutComment;

service PutComment {
  rpc PutComment(Request) returns (Response) {}
}

message Request {
  string SessionId = 1;
  // 订单id
  string OrderId = 2;
  // 订单评论
  string OrderComment = 3;
}

message Response {
  string ErrNo = 1;
  string ErrMsg = 2;
}
```

```shell
$ cd /home/lpgit/go/src/ihome/PutComment
$ protoc --proto_path=. --go_out=. --micro_out=. proto/putcomment/putcomment.proto
```



### 在 Web 中添加路由



### srv 下的handler



### web 下的 handler



